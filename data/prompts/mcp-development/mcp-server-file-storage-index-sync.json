{
  "id": "mcp-server-file-storage-index-sync",
  "name": "MCP Server File Storage Index Synchronization",
  "description": "Fix mcp-prompts file storage index.json synchronization issues",
  "content": "# MCP Server File Storage Index Synchronization\n\n## Problem\nmcp-prompts file storage `index.json` gets out of sync with actual prompt files, causing:\n- Prompts not appearing in `list_prompts` results\n- Stale metadata in index\n- Missing prompts that exist as files\n- Duplicate entries or orphaned references\n\n## Root Cause Analysis\n\n### Why Index Gets Out of Sync\n1. **External File Modifications**: Files edited directly without using MCP API\n2. **Manual File Operations**: Files added/removed via filesystem, not through server\n3. **Corrupted Index**: JSON parse errors or incomplete writes\n4. **Concurrent Access**: Multiple processes modifying files simultaneously\n5. **Version Mismatch**: Index format changed but old index still exists\n\n## Solution: Regenerate Index\n\n### Step 1: Backup Current Index\n```bash\ncd /path/to/mcp-prompts/data/prompts\ncp index.json index.json.backup\n```\n\n### Step 2: Remove Corrupted Index\n```bash\n# Option A: Delete and let server rebuild\nrm index.json\n\n# Option B: Clear and regenerate\necho '{\"prompts\": []}' > index.json\n```\n\n### Step 3: Regenerate Index\n\n#### Method 1: Server Auto-Regeneration\n```bash\n# Restart mcp-prompts server\n# Server should detect missing/invalid index and rebuild\nmcp-prompts start --mode mcp\n\n# Or if using standalone:\nSTORAGE_TYPE=file PROMPTS_DIR=/path/to/prompts mcp-prompts start\n```\n\n#### Method 2: Manual Regeneration Script\n```python\n#!/usr/bin/env python3\n# regenerate_prompts_index.py\n\nimport json\nimport os\nfrom pathlib import Path\nfrom datetime import datetime\n\nprompts_dir = Path('/path/to/mcp-prompts/data/prompts')\n\n# Find all JSON files (excluding index.json)\nprompt_files = [f for f in prompts_dir.rglob('*.json') \n                 if f.name != 'index.json']\n\nvalid_prompts = []\nfor filepath in prompt_files:\n    try:\n        with open(filepath, 'r') as f:\n            data = json.load(f)\n        \n        # Validate required fields\n        if all(k in data for k in ['id', 'name', 'description', 'content']):\n            entry = {\n                'id': data['id'],\n                'name': data['name'],\n                'description': data['description'],\n                'tags': data.get('tags', []),\n                'isTemplate': data.get('isTemplate', False),\n                'metadata': data.get('metadata', {})\n            }\n            valid_prompts.append(entry)\n    except Exception as e:\n        print(f\"Skipping {filepath}: {e}\")\n\n# Create new index\nindex_data = {\n    'prompts': sorted(valid_prompts, key=lambda x: x['id']),\n    'metadata': {\n        'totalPrompts': len(valid_prompts),\n        'lastUpdated': datetime.utcnow().isoformat() + 'Z',\n        'version': '1.0'\n    }\n}\n\n# Write index\nwith open(prompts_dir / 'index.json', 'w') as f:\n    json.dump(index_data, f, indent=2)\n\nprint(f\"✓ Regenerated index with {len(valid_prompts)} prompts\")\n```\n\n### Step 4: Verify Index\n```bash\n# Check index structure\njq '.prompts | length' index.json\n\n# List all prompt IDs\njq -r '.prompts[].id' index.json | sort\n\n# Compare with actual files\nfind . -name '*.json' ! -name 'index.json' | wc -l\n# Should match prompt count\n```\n\n## Prevention Strategies\n\n### 1. Always Use API for Modifications\n```bash\n# ✅ Good: Use MCP tools\nmcp-prompts create --name \"my-prompt\" --content \"...\"\nmcp-prompts update --name \"my-prompt\" --content \"...\"\n\n# ❌ Bad: Direct file editing\nvim data/prompts/my-prompt.json  # Bypasses index update\n```\n\n### 2. Use Seed Scripts for Bulk Operations\n```python\n# scripts/seed_prompts.py\n# Bulk import with index update\nfor prompt_data in prompts_to_import:\n    # Use API, not direct file write\n    create_prompt_via_api(prompt_data)\n```\n\n### 3. Backup Before Bulk Operations\n```bash\n# Before major changes\ncp index.json index.json.$(date +%Y%m%d_%H%M%S).backup\n```\n\n### 4. Validate After External Changes\n```bash\n# If files modified externally, regenerate\npython scripts/regenerate_prompts_index.py\n```\n\n## Detection: How to Know Index is Out of Sync\n\n### Symptoms\n- `list_prompts` returns fewer results than files exist\n- Prompts visible in filesystem but not in API results\n- Stale metadata (old descriptions, missing tags)\n- Duplicate prompt IDs in index\n- JSON parse errors when reading index\n\n### Diagnostic Commands\n```bash\n# Count files vs index entries\nFILE_COUNT=$(find . -name '*.json' ! -name 'index.json' | wc -l)\nINDEX_COUNT=$(jq '.prompts | length' index.json)\necho \"Files: $FILE_COUNT, Index: $INDEX_COUNT\"\n\n# Find missing prompts\nfor file in $(find . -name '*.json' ! -name 'index.json'); do\n    ID=$(jq -r '.id' \"$file\" 2>/dev/null)\n    if [ -n \"$ID\" ]; then\n        if ! jq -e \".prompts[] | select(.id == \\\"$ID\\\")\" index.json > /dev/null; then\n            echo \"Missing from index: $ID ($file)\"\n        fi\n    fi\ndone\n\n# Find orphaned index entries\njq -r '.prompts[].id' index.json | while read id; do\n    if ! find . -name \"${id}.json\" -o -name \"*${id}*.json\" | grep -q .; then\n        echo \"Orphaned in index: $id\"\n    fi\ndone\n```\n\n## Index Structure\n\n### Expected Format\n```json\n{\n  \"prompts\": [\n    {\n      \"id\": \"prompt-id\",\n      \"name\": \"Prompt Name\",\n      \"description\": \"Description\",\n      \"tags\": [\"tag1\", \"tag2\"],\n      \"isTemplate\": false,\n      \"metadata\": {}\n    }\n  ],\n  \"metadata\": {\n    \"totalPrompts\": 38,\n    \"lastUpdated\": \"2026-01-01T03:00:00.000Z\",\n    \"version\": \"1.0\"\n  }\n}\n```\n\n## Related Patterns\n\n- Similar to `esp32-flatbuffers-schema-sync-workflow` (code generation sync)\n- Use with `mcp-server-troubleshooting` for broader MCP issues\n\n## Success Metrics\n\n- **Sync Accuracy**: 100% (all files in index, no orphans)\n- **Regeneration Time**: < 5 seconds for 100 prompts\n- **Detection Time**: < 1 second to identify sync issues",
  "isTemplate": false,
  "tags": ["infrastructure", "mcp", "file-storage", "data-consistency", "indexing"],
  "category": "mcp-development",
  "version": 1,
  "createdAt": "2026-01-01T03:00:00.000Z",
  "updatedAt": "2026-01-01T03:00:00.000Z",
  "metadata": {
    "context": ["infrastructure", "mcp", "file-storage", "data-consistency"],
    "problem": "mcp-prompts file storage index.json gets out of sync with actual files",
    "success_count": 1,
    "confidence": "medium",
    "related_prompts": [
      "esp32-flatbuffers-schema-sync-workflow"
    ]
  }
}