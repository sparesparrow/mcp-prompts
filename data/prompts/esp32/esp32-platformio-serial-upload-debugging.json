{
  "id": "esp32-platformio-serial-upload-debugging",
  "name": "ESP32 PlatformIO Serial Upload Debugging",
  "description": "Diagnose and fix PlatformIO upload failures for ESP32 devices",
  "content": "# ESP32 PlatformIO Serial Upload Debugging\n\n## Problem\nPlatformIO upload fails or device not detected during firmware deployment to ESP32.\n\n## Pre-Flight Checklist\n\nBefore troubleshooting, verify these basics:\n\n- [ ] **USB cable is data-capable** (not power-only)\n  - Test: `lsusb | grep -i esp` should show device\n  - Try different USB cable if device not detected\n\n- [ ] **Device appears in device list**\n  ```bash\n  pio device list\n  # Should show /dev/ttyACM0 or /dev/ttyUSB0\n  ```\n\n- [ ] **Correct environment in platformio.ini**\n  ```ini\n  [env:esp32-s3]\n  platform = espressif32@6.4.0\n  board = esp32-s3-devkitc-1\n  upload_port = /dev/ttyACM1\n  ```\n\n- [ ] **RTS/DTR pins configured for auto-reset**\n  - ESP32-S3: Usually automatic via USB-CDC\n  - ESP32 (classic): May need manual reset button\n\n- [ ] **Baud rate matches bootloader**\n  - Default: 460800 or 921600\n  - Check in `platformio.ini`: `upload_speed = 921600`\n\n## Common Fixes\n\n### Permission Denied Error\n```bash\n# Add user to dialout group\nsudo usermod -a -G dialout $USER\n\n# Logout and login again, or:\nnewgrp dialout\n\n# Verify permissions\nls -l /dev/ttyACM* | grep dialout\n```\n\n### Port In Use / Resource Temporarily Unavailable\n```bash\n# Find process using port\nlsof /dev/ttyACM1\n# or\nfuser /dev/ttyACM1\n\n# Kill conflicting processes\nkillall pio\nkillall minicom\nkillall screen\n\n# Or use different port if multiple devices\npio run --target upload --upload-port /dev/ttyACM0\n```\n\n### Device Not Detected\n```bash\n# List USB devices\nlsusb | grep -i esp\n\n# Test with esptool directly\nesptool.py --port /dev/ttyACM1 chip_id\n\n# Check dmesg for device connection\nsudo dmesg | tail -20\n```\n\n### Upload Timeout / Connection Lost\n```bash\n# Reduce upload speed\n# In platformio.ini:\nupload_speed = 115200\n\n# Try manual reset sequence\n# 1. Hold BOOT button\n# 2. Press RESET button\n# 3. Release BOOT button\n# 4. Run upload command\n\n# Use different upload protocol\nupload_protocol = esptool\n# or\nupload_protocol = esp-builtin\n```\n\n### Wrong Board / Environment Mismatch\n```bash\n# Verify board matches hardware\npio boards | grep esp32\n\n# Check current environment\npio run --list-targets\n\n# Use correct environment\npio run --environment esp32-s3 --target upload\n```\n\n## Debugging Workflow\n\n### Step 1: Verify Device Detection\n```bash\n# Check if device is visible\npio device list\n\n# Expected output:\n# /dev/ttyACM1\n#   Hardware ID: USB VID:PID=303A:0001\n#   Description: USB JTAG/serial debug unit\n```\n\n### Step 2: Test Serial Communication\n```bash\n# Open serial monitor\npio device monitor --port /dev/ttyACM1 --baud 115200\n\n# Should see boot messages or garbage (if baud mismatch)\n# If nothing: device not responding or wrong baud rate\n```\n\n### Step 3: Test Upload Process\n```bash\n# Clean build first\npio run --target clean\n\n# Build firmware\npio run --environment esp32-s3\n\n# Upload with verbose output\npio run --environment esp32-s3 --target upload -v\n\n# Watch for specific error messages:\n# - \"Failed to connect\": Port/permission issue\n# - \"Timed out\": Reset sequence problem\n# - \"Wrong chip\": Board mismatch\n```\n\n## PlatformIO Configuration\n\n### Recommended platformio.ini Settings\n```ini\n[env:esp32-s3]\nplatform = espressif32@6.4.0\nboard = esp32-s3-devkitc-1\nframework = arduino\n\n# Upload settings\nupload_port = /dev/ttyACM1\nupload_speed = 921600\nupload_protocol = esp-builtin\n\n# Monitor settings\nmonitor_port = /dev/ttyACM1\nmonitor_speed = 115200\nmonitor_filters = default\n\n# Build settings\nbuild_flags =\n    -D CORE_DEBUG_LEVEL=5\n    -D PLATFORM_ESP32\n    -std=c++17\n```\n\n## Hardware-Specific Notes\n\n### ESP32-S3 (USB-CDC)\n- Uses native USB for serial (no USB-to-Serial chip)\n- Auto-reset usually works\n- May need `ARDUINO_USB_CDC_ON_BOOT=1` in build flags\n\n### ESP32 Classic (CP2102/CH340)\n- Requires USB-to-Serial driver\n- Install: `sudo apt install modemmanager`\n- May need manual reset button press\n\n### ESP32-WROOM/WROVER\n- Similar to classic ESP32\n- Check for PSRAM configuration if using WROVER\n\n## Validation\n\nAfter successful upload:\n\n```bash\n# Serial monitor should show:\n# - Boot messages\n# - WiFi initialization\n# - Application startup logs\n\n# Test with:\npio device monitor --port /dev/ttyACM1 --baud 115200\n```\n\n## Related Patterns\n\n- Use with `esp32-network-ap-mode-configuration` for full setup\n- See `esp32-flatbuffers-schema-sync-workflow` for build issues\n- Combine with `embedded-audio-fft-memory-constraints` for optimization\n\n## Success Metrics\n\n- **Upload Time**: < 30 seconds for typical firmware\n- **Success Rate**: > 95% on first attempt\n- **Detection Time**: < 2 seconds after device connection",
  "isTemplate": false,
  "tags": ["embedded", "esp32", "platformio", "build", "upload", "debugging"],
  "category": "esp32",
  "version": 1,
  "createdAt": "2026-01-01T03:00:00.000Z",
  "updatedAt": "2026-01-01T03:00:00.000Z",
  "metadata": {
    "context": ["embedded", "esp32", "platformio", "build"],
    "problem": "Diagnose and fix PlatformIO upload failures",
    "success_count": 1,
    "confidence": "medium",
    "related_prompts": [
      "esp32-network-ap-mode-configuration",
      "esp32-flatbuffers-schema-sync-workflow"
    ]
  }
}